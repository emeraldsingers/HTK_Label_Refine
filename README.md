# HTK Label Refiner for NNSVS/DiffSinger

A Python script for cleaning and refining HTK label files (.lab) generated by WFL ASR (Waffle) for use with NNSVS/DiffSinger singing voice synthesis systems.

## Overview

When using WFL ASR (Waffle) to generate phoneme alignments, the resulting `.lab` files often contain fragmented phonemes with very short durations and small gaps between similar phonemes. This script consolidates these fragments into cleaner, more usable labels for singing voice synthesis.

## What it does

- **Merges similar phonemes**: Groups phonemes of the same type (vowels, consonants, sibilants, etc.) that are close together
- **Cleans silence labels**: Converts all silence markers (`pau`, `sil`, `SP`, etc.) into unified `SP` labels
- **Removes micro-fragments**: Eliminates very short phoneme segments that can cause issues in synthesis
- **Preserves timing accuracy**: Maintains the original start and end times while consolidating labels

## Features

### Phoneme Grouping
The script categorizes phonemes into groups for intelligent merging:
- **Vowels**: `a`, `e`, `i`, `o`, `u`, `N`
- **Consonants**: `b`, `c`, `d`, `f`, `g`, `h`, `j`, `k`, `l`, `m`, `n`, `p`, `q`, `r`, `t`, `v`, `w`
- **Sibilants**: `s`, `z`, `sh`, `zh`, `ts`, `dz`, `ch`, `dj`, `x`
- **Liquids**: `l`, `r`
- **Nasals**: `m`, `n`, `ng`
- **Stops**: `p`, `b`, `t`, `d`, `k`, `g`
- **Fricatives**: `f`, `v`, `th`, `dh`, `s`, `z`, `sh`, `zh`, `h`
- **Silence**: `pau`, `sil`, `SP`, (all converted to `SP`)
- **Special**: `vf`, `cl`

### Two-Pass Processing
1. **First pass**: Merges phonemes within the same group that have small gaps
2. **Second pass**: Consolidates consecutive `SP` labels into single silence segments

## Installation

No additional dependencies required - uses only Python standard library.

```bash
git clone https://github.com/emeraldsingers/HTK_Label_Refine
cd htk-label-refiner
```

## Usage

### Command Line Interface

```bash
# Basic usage - process all .lab files in a directory
python htk_refiner.py /path/to/lab/files

# Specify output directory
python htk_refiner.py /path/to/lab/files -o /path/to/output

# Adjust maximum gap threshold (in seconds)
python htk_refiner.py /path/to/lab/files -g 0.05
```

### Parameters

- `input_dir`: Path to directory containing `.lab` files
- `-o, --output`: Output directory (default: `input_dir/refined_labels`)
- `-g, --gap`: Maximum gap in seconds for merging phonemes (default: 0.1)

### Programmatic Usage

```python
from htk_refiner import process_lab_files

# Process files with default settings
process_lab_files("/path/to/lab/files")

# Custom settings
process_lab_files("/path/to/lab/files", 
                 output_dir="/path/to/output",
                 max_gap_seconds=0.05)
```

## Examples

### Input (fragmented from WFL ASR):
```
598491409 599945248 o
600000575 600981845 a
600982279 601038594 o
603058859 636724222 pau
636731353 638720642 sil
638727307 639321270 pau
639326331 655763342 sil
```

### Output (cleaned):
```
598491409 601038594 o
603058859 655763342 SP
```

## Time Format

HTK uses 100-nanosecond units. The script automatically converts:
- HTK time units → seconds: `time * 10^-7`
- Seconds → HTK time units: `time / 10^-7`

## File Structure

```
input_directory/
├── song1.lab
├── song2.lab
└── song3.lab

output_directory/
├── song1.lab    # cleaned version
├── song2.lab    # cleaned version
└── song3.lab    # cleaned version
```

## Customization

### Modifying Phoneme Groups

Edit the `PHONEME_GROUPS` dictionary in the script to match your phoneme set:

```python
PHONEME_GROUPS = {
    'vowels': ['a', 'e', 'i', 'o', 'u'],
    'consonants': ['b', 'c', 'd', 'f', 'g'],
    # Add your custom groups here
}
```

### Adjusting Merge Rules

Modify the `should_merge_phonemes()` function to add custom merging logic for specific phoneme combinations.

## Use Cases

- **Post-processing WFL ASR output** for NNSVS training
- **Cleaning fragmented alignments** from automatic speech recognition
- **Preparing labels for DiffSinger** and other neural singing synthesis
- **Standardizing phoneme representations** across different ASR outputs

## Technical Details

- **Input format**: HTK label files with start_time, end_time, phoneme
- **Output format**: Same HTK format with consolidated labels
- **Encoding**: UTF-8 support for international phoneme sets
- **Memory efficient**: Processes files one at a time

## Troubleshooting

### Common Issues

1. **No .lab files found**: Check that input directory contains `.lab` files
2. **Permission errors**: Ensure write permissions for output directory
3. **Encoding issues**: Files should be UTF-8 encoded

### Debug Mode

Add print statements or increase verbosity by modifying the `process_lab_files()` function to see detailed processing information.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Add your improvements
4. Submit a pull request

## License

MIT License - see LICENSE file for details.

## Related Projects

- [DiffSinger](https://github.com/openvpi/DiffSinger) - Diffusion-based singing voice synthesis
- [WFL ASR](https://github.com/MLo7Ghinsan/WFL-ASR) - Whisper/WavLM for Phoneme Labeling

## Acknowledgments

Created for the singing voice synthesis community to improve the pipeline from automatic speech recognition to neural singing synthesis.
